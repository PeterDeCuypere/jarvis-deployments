<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Standardized Residuals - Cascaded CSTR</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            padding: 20px;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #f8fafc;
        }
        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
        }
        .chart-container {
            background: #1e293b;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .chart {
            width: 100%;
            height: 400px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }
        .stat-card {
            background: #1e293b;
            border-radius: 8px;
            padding: 15px;
        }
        .stat-card h3 {
            color: #94a3b8;
            font-size: 14px;
            margin-bottom: 10px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 12px;
            color: #64748b;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #94a3b8;
        }
    </style>
</head>
<body>
    <h1>Standardized Residuals (PV - SP)</h1>
    <p class="subtitle">Cascaded CSTR Process Data Analysis</p>

    <div id="loading" class="loading">Loading data...</div>
    <div id="content" style="display: none;">
        <div class="chart-container">
            <div id="combined-chart" class="chart"></div>
        </div>

        <div class="chart-container">
            <div id="tt101-chart" class="chart"></div>
        </div>

        <div class="chart-container">
            <div id="tt102-chart" class="chart"></div>
        </div>

        <div class="chart-container">
            <div id="lt101-chart" class="chart"></div>
        </div>

        <div class="chart-container">
            <div id="lt102-chart" class="chart"></div>
        </div>

        <div class="stats-grid" id="stats-grid"></div>
    </div>

    <script>
        const plotLayout = {
            paper_bgcolor: '#1e293b',
            plot_bgcolor: '#1e293b',
            font: { color: '#e2e8f0' },
            xaxis: {
                title: 'Sample Index',
                gridcolor: '#334155',
                zerolinecolor: '#475569'
            },
            yaxis: {
                title: 'Standardized Residual (σ)',
                gridcolor: '#334155',
                zerolinecolor: '#ef4444',
                zerolinewidth: 2
            },
            margin: { t: 50, r: 30, b: 50, l: 60 },
            hovermode: 'x unified',
            showlegend: true,
            legend: {
                orientation: 'h',
                y: 1.1,
                bgcolor: 'rgba(0,0,0,0)'
            }
        };

        const plotConfig = {
            responsive: true,
            displayModeBar: true,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            displaylogo: false
        };

        async function loadAndPlot() {
            try {
                const response = await fetch('cascaded_cstr.csv');
                const csvText = await response.text();
                const data = parseCSV(csvText);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('content').style.display = 'block';

                const pairs = [
                    { sp: 'SP_TT_101', pv: 'TT_101', name: 'Temperature 101', color: '#3b82f6' },
                    { sp: 'SP_TT_102', pv: 'TT_102', name: 'Temperature 102', color: '#10b981' },
                    { sp: 'SP_LT_101', pv: 'LT_101', name: 'Level 101', color: '#f59e0b' },
                    { sp: 'SP_LT_102', pv: 'LT_102', name: 'Level 102', color: '#ef4444' }
                ];

                const residualsData = pairs.map(pair => {
                    const residuals = [];
                    for (let i = 0; i < data.length; i++) {
                        const pv = parseFloat(data[i][pair.pv]);
                        const sp = parseFloat(data[i][pair.sp]);
                        if (!isNaN(pv) && !isNaN(sp)) {
                            residuals.push(pv - sp);
                        }
                    }

                    const mean = residuals.reduce((a, b) => a + b, 0) / residuals.length;
                    const std = Math.sqrt(residuals.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / residuals.length);
                    const standardized = residuals.map(r => (r - mean) / std);

                    return {
                        ...pair,
                        residuals,
                        standardized,
                        mean,
                        std,
                        min: Math.min(...standardized),
                        max: Math.max(...standardized)
                    };
                });

                // Combined plot
                const combinedTraces = residualsData.map(d => ({
                    x: d.standardized.map((_, i) => i),
                    y: d.standardized,
                    type: 'scatter',
                    mode: 'lines',
                    name: d.name,
                    line: { color: d.color, width: 1.5 },
                    hovertemplate: `${d.name}<br>Index: %{x}<br>Residual: %{y:.3f}σ<extra></extra>`
                }));

                // Add ±2σ and ±3σ reference lines
                const xRange = [0, residualsData[0].standardized.length - 1];
                const refLines = [
                    { y: 3, color: '#ef4444', dash: 'dash', name: '+3σ' },
                    { y: 2, color: '#f59e0b', dash: 'dot', name: '+2σ' },
                    { y: -2, color: '#f59e0b', dash: 'dot', name: '-2σ' },
                    { y: -3, color: '#ef4444', dash: 'dash', name: '-3σ' }
                ];

                refLines.forEach(ref => {
                    combinedTraces.push({
                        x: xRange,
                        y: [ref.y, ref.y],
                        type: 'scatter',
                        mode: 'lines',
                        name: ref.name,
                        line: { color: ref.color, dash: ref.dash, width: 1 },
                        hoverinfo: 'skip',
                        showlegend: false
                    });
                });

                Plotly.newPlot('combined-chart', combinedTraces, {
                    ...plotLayout,
                    title: { text: 'All Standardized Residuals', font: { size: 16 } }
                }, plotConfig);

                // Individual plots
                const chartIds = ['tt101-chart', 'tt102-chart', 'lt101-chart', 'lt102-chart'];
                residualsData.forEach((d, i) => {
                    const traces = [
                        {
                            x: d.standardized.map((_, j) => j),
                            y: d.standardized,
                            type: 'scatter',
                            mode: 'lines',
                            name: d.name,
                            line: { color: d.color, width: 1.5 },
                            fill: 'tozeroy',
                            fillcolor: d.color + '20',
                            hovertemplate: `Index: %{x}<br>Residual: %{y:.3f}σ<extra></extra>`
                        }
                    ];

                    // Add reference lines
                    refLines.forEach(ref => {
                        traces.push({
                            x: xRange,
                            y: [ref.y, ref.y],
                            type: 'scatter',
                            mode: 'lines',
                            name: ref.name,
                            line: { color: ref.color, dash: ref.dash, width: 1 },
                            hoverinfo: 'skip',
                            showlegend: false
                        });
                    });

                    Plotly.newPlot(chartIds[i], traces, {
                        ...plotLayout,
                        title: { text: `${d.name} (${d.pv} - ${d.sp})`, font: { size: 16 } },
                        showlegend: false
                    }, plotConfig);
                });

                // Stats cards
                const statsGrid = document.getElementById('stats-grid');
                residualsData.forEach(d => {
                    const outsideTwo = d.standardized.filter(r => Math.abs(r) > 2).length;
                    const outsideThree = d.standardized.filter(r => Math.abs(r) > 3).length;

                    statsGrid.innerHTML += `
                        <div class="stat-card">
                            <h3>${d.name}</h3>
                            <div class="stat-value" style="color: ${d.color}">${d.std.toFixed(4)}</div>
                            <div class="stat-label">Raw Std Dev (${d.pv} units)</div>
                            <div style="margin-top: 10px; font-size: 13px;">
                                <div>Mean residual: ${d.mean.toFixed(4)}</div>
                                <div>Outside ±2σ: ${outsideTwo} (${(100*outsideTwo/d.standardized.length).toFixed(1)}%)</div>
                                <div>Outside ±3σ: ${outsideThree} (${(100*outsideThree/d.standardized.length).toFixed(1)}%)</div>
                            </div>
                        </div>
                    `;
                });

            } catch (error) {
                document.getElementById('loading').textContent = 'Error loading data: ' + error.message;
                console.error(error);
            }
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                const row = {};
                headers.forEach((header, j) => {
                    row[header] = values[j]?.trim();
                });
                data.push(row);
            }
            return data;
        }

        loadAndPlot();
    </script>
</body>
</html>
